name: Scheduled Maintenance

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  check-stale-issues:
    name: Check for Stale Issues
    runs-on: ubuntu-latest

    steps:
      - name: Find stale issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const days_until_stale = 60;
            const days_until_close = 7;
            const ms_per_day = 86400000;
            const now = Date.now();
            const stale_date = new Date(now - (days_until_stale * ms_per_day)).toISOString();

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc',
              per_page: 100,
            });

            let stale_count = 0;
            const stale_issues = [];

            for (const issue of issues.data) {
              // Skip pull requests
              if (issue.pull_request) continue;

              // Skip issues with certain labels
              const exemptLabels = ['pinned', 'security', 'bug'];
              if (issue.labels.some(label => exemptLabels.includes(label.name))) continue;

              if (issue.updated_at < stale_date) {
                stale_count++;
                stale_issues.push({
                  number: issue.number,
                  title: issue.title,
                  updated: issue.updated_at,
                  url: issue.html_url
                });

                // Add stale label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['stale']
                });

                // Add comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `This issue has been automatically marked as stale because it has not had recent activity. It will be closed in ${days_until_close} days if no further activity occurs. Thank you for your contributions.`
                });
              }
            }

            // Create summary
            core.summary
              .addHeading('ðŸ“‹ Stale Issues Report', 2)
              .addRaw(`Found ${stale_count} stale issues (no activity in ${days_until_stale} days)`)
              .addBreak();

            if (stale_issues.length > 0) {
              const tableData = [
                ['Issue', 'Title', 'Last Updated'],
                ...stale_issues.map(i => [
                  `#${i.number}`,
                  i.title.substring(0, 50) + (i.title.length > 50 ? '...' : ''),
                  new Date(i.updated).toLocaleDateString()
                ])
              ];
              core.summary.addTable(tableData);
            }

            core.summary.write();

  repository-stats:
    name: Repository Statistics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gather repository statistics
        run: |
          echo "## ðŸ“Š Repository Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count files by type
          echo "### File Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "| File Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript files | $(find . -name "*.ts" -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript files | $(find . -name "*.js" -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON files | $(find . -name "*.json" -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML files | $(find . -name "*.yml" -o -name "*.yaml" -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown files | $(find . -name "*.md" -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Git statistics
          echo "### Git Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total commits | $(git rev-list --all --count) |" >> $GITHUB_STEP_SUMMARY
          echo "| Contributors | $(git shortlog -sn --all | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | $(git branch -r | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | $(git tag | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Code statistics
          echo "### Code Statistics:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find . -name "*.ts" -type f -exec wc -l {} + | sort -rn | head -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "*Top 10 largest TypeScript files by line count*" >> $GITHUB_STEP_SUMMARY
